<script>
const API = "/api";

async function renderStats() {
  try {
    const userId = localStorage.getItem("pp_userId") || null;

    // Fetch global stats
    const statsResp = await fetch(API + "/stats");
    const statsData = await statsResp.json();
    const stats = statsData.stats || {};

    // Fetch which links current user clicked today
    let clickedLinks = [];
    if (userId) {
      try {
        const resp = await fetch(API + "/hasClicked?userId=" + userId);
        const j = await resp.json();
        if (j.success) clickedLinks = j.clickedLinks;
      } catch(err) { console.error("hasClicked error", err); }
    }

    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "";

    const entries = Object.entries(stats);
    if(entries.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No data yet</td></tr>";
      return;
    }

    // Sort by totalCount descending
    entries.sort((a,b)=> (b[1].totalCount||0) - (a[1].totalCount||0));

    entries.forEach(([linkId, info])=>{
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.textContent = linkId;

      const tdUrl = document.createElement("td");
      const a = document.createElement("a");
      a.href = info.linkUrl;
      a.target = "_blank";
      a.textContent = info.linkUrl;
      tdUrl.appendChild(a);

      const tdCount = document.createElement("td");
      tdCount.className = "count";
      tdCount.textContent = info.totalCount || 0;

      const tdUser = document.createElement("td");
      tdUser.textContent = clickedLinks.includes(linkId) ? "✅ You clicked today" : "—";

      tr.appendChild(tdId);
      tr.appendChild(tdUrl);
      tr.appendChild(tdCount);
      tr.appendChild(tdUser);

      tbody.appendChild(tr);
    });

  } catch(err) {
    console.error("renderStats error", err);
  }
}

// Auto-refresh every 5 seconds
renderStats();
setInterval(renderStats, 5000);
</script>
