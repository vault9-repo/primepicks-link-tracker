<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PrimePicks Click Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h1 { text-align:center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #f4f4f4; }
    tr:nth-child(even) { background-color: #fafafa; }
    a { color: #0b74da; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<h1>ðŸ“Š PrimePicks Real-Time Click Stats</h1>

<table id="statsTable">
  <thead>
    <tr>
      <th>Link ID</th>
      <th>Link URL</th>
      <th>Total Clicks</th>
      <th>Your Status</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="4" style="text-align:center;">Loading stats...</td></tr>
  </tbody>
</table>

<script>
(async function() {
  const API = location.origin + "/api";

  // Get or create userId
  let userId = localStorage.getItem("pp_userId");
  if (!userId) {
    try {
      const r = await fetch(API + "/register", { method: "POST" });
      const j = await r.json();
      userId = j.userId;
      localStorage.setItem("pp_userId", userId);
    } catch(err) {
      userId = "u-" + Math.random().toString(36).slice(2) + Date.now();
      localStorage.setItem("pp_userId", userId);
    }
  }

  async function renderStats() {
    try {
      // 1. Fetch global stats
      const statsResp = await fetch(API + "/stats");
      const statsData = await statsResp.json();
      const stats = statsData.stats || {};

      // 2. Fetch which links current user clicked today
      let clickedLinks = [];
      if (userId) {
        try {
          const resp = await fetch(API + "/hasClicked?userId=" + userId);
          const j = await resp.json();
          if (j.success) clickedLinks = j.clickedLinks;
        } catch(err){ console.error(err); }
      }

      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "";

      const entries = Object.entries(stats);
      if(entries.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No data yet</td></tr>";
        return;
      }

      entries.sort((a,b)=> (b[1].totalCount||0) - (a[1].totalCount||0));

      entries.forEach(([linkId, info]) => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = linkId;

        const tdUrl = document.createElement("td");
        const a = document.createElement("a");
        a.href = info.linkUrl;
        a.target = "_blank";
        a.textContent = info.linkUrl;
        tdUrl.appendChild(a);

        const tdCount = document.createElement("td");
        tdCount.textContent = info.totalCount || 0;

        const tdUser = document.createElement("td");
        tdUser.textContent = clickedLinks.includes(linkId) ? "âœ… You clicked today" : "â€”";

        tr.appendChild(tdId);
        tr.appendChild(tdUrl);
        tr.appendChild(tdCount);
        tr.appendChild(tdUser);

        tbody.appendChild(tr);
      });

    } catch(err) {
      console.error("renderStats error:", err);
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;color:red'>Error loading stats</td></tr>";
    }
  }

  // Initial render + auto-refresh every 5 seconds
  renderStats();
  setInterval(renderStats, 5000);

})();
</script>

</body>
</html>
